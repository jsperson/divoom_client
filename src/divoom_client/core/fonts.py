"""Bitmap font support for pixel displays."""

from typing import Optional

# 5x7 bitmap font - each character is 5 pixels wide, 7 pixels tall
# Each entry is a list of 7 integers, where each integer's bits represent the 5 columns
FONT_5X7: dict[str, list[int]] = {
    " ": [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000],
    "!": [0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00000, 0b00100],
    '"': [0b01010, 0b01010, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000],
    "#": [0b01010, 0b11111, 0b01010, 0b01010, 0b11111, 0b01010, 0b00000],
    "$": [0b00100, 0b01111, 0b10100, 0b01110, 0b00101, 0b11110, 0b00100],
    "%": [0b11001, 0b11010, 0b00100, 0b00100, 0b01011, 0b10011, 0b00000],
    "&": [0b01100, 0b10010, 0b01100, 0b01101, 0b10010, 0b01101, 0b00000],
    "'": [0b00100, 0b00100, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000],
    "(": [0b00010, 0b00100, 0b01000, 0b01000, 0b01000, 0b00100, 0b00010],
    ")": [0b01000, 0b00100, 0b00010, 0b00010, 0b00010, 0b00100, 0b01000],
    "*": [0b00000, 0b00100, 0b10101, 0b01110, 0b10101, 0b00100, 0b00000],
    "+": [0b00000, 0b00100, 0b00100, 0b11111, 0b00100, 0b00100, 0b00000],
    ",": [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00100, 0b01000],
    "-": [0b00000, 0b00000, 0b00000, 0b11111, 0b00000, 0b00000, 0b00000],
    ".": [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00100],
    "/": [0b00001, 0b00010, 0b00010, 0b00100, 0b01000, 0b01000, 0b10000],
    "0": [0b01110, 0b10001, 0b10011, 0b10101, 0b11001, 0b10001, 0b01110],
    "1": [0b00100, 0b01100, 0b00100, 0b00100, 0b00100, 0b00100, 0b01110],
    "2": [0b01110, 0b10001, 0b00001, 0b00110, 0b01000, 0b10000, 0b11111],
    "3": [0b01110, 0b10001, 0b00001, 0b00110, 0b00001, 0b10001, 0b01110],
    "4": [0b00010, 0b00110, 0b01010, 0b10010, 0b11111, 0b00010, 0b00010],
    "5": [0b11111, 0b10000, 0b11110, 0b00001, 0b00001, 0b10001, 0b01110],
    "6": [0b00110, 0b01000, 0b10000, 0b11110, 0b10001, 0b10001, 0b01110],
    "7": [0b11111, 0b00001, 0b00010, 0b00100, 0b01000, 0b01000, 0b01000],
    "8": [0b01110, 0b10001, 0b10001, 0b01110, 0b10001, 0b10001, 0b01110],
    "9": [0b01110, 0b10001, 0b10001, 0b01111, 0b00001, 0b00010, 0b01100],
    ":": [0b00000, 0b00000, 0b00100, 0b00000, 0b00100, 0b00000, 0b00000],
    ";": [0b00000, 0b00000, 0b00100, 0b00000, 0b00100, 0b00100, 0b01000],
    "<": [0b00010, 0b00100, 0b01000, 0b10000, 0b01000, 0b00100, 0b00010],
    "=": [0b00000, 0b00000, 0b11111, 0b00000, 0b11111, 0b00000, 0b00000],
    ">": [0b01000, 0b00100, 0b00010, 0b00001, 0b00010, 0b00100, 0b01000],
    "?": [0b01110, 0b10001, 0b00001, 0b00110, 0b00100, 0b00000, 0b00100],
    "@": [0b01110, 0b10001, 0b10111, 0b10101, 0b10110, 0b10000, 0b01110],
    "A": [0b01110, 0b10001, 0b10001, 0b11111, 0b10001, 0b10001, 0b10001],
    "B": [0b11110, 0b10001, 0b10001, 0b11110, 0b10001, 0b10001, 0b11110],
    "C": [0b01110, 0b10001, 0b10000, 0b10000, 0b10000, 0b10001, 0b01110],
    "D": [0b11110, 0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b11110],
    "E": [0b11111, 0b10000, 0b10000, 0b11110, 0b10000, 0b10000, 0b11111],
    "F": [0b11111, 0b10000, 0b10000, 0b11110, 0b10000, 0b10000, 0b10000],
    "G": [0b01110, 0b10001, 0b10000, 0b10111, 0b10001, 0b10001, 0b01110],
    "H": [0b10001, 0b10001, 0b10001, 0b11111, 0b10001, 0b10001, 0b10001],
    "I": [0b01110, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b01110],
    "J": [0b00111, 0b00010, 0b00010, 0b00010, 0b00010, 0b10010, 0b01100],
    "K": [0b10001, 0b10010, 0b10100, 0b11000, 0b10100, 0b10010, 0b10001],
    "L": [0b10000, 0b10000, 0b10000, 0b10000, 0b10000, 0b10000, 0b11111],
    "M": [0b10001, 0b11011, 0b10101, 0b10101, 0b10001, 0b10001, 0b10001],
    "N": [0b10001, 0b11001, 0b10101, 0b10011, 0b10001, 0b10001, 0b10001],
    "O": [0b01110, 0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b01110],
    "P": [0b11110, 0b10001, 0b10001, 0b11110, 0b10000, 0b10000, 0b10000],
    "Q": [0b01110, 0b10001, 0b10001, 0b10001, 0b10101, 0b10010, 0b01101],
    "R": [0b11110, 0b10001, 0b10001, 0b11110, 0b10100, 0b10010, 0b10001],
    "S": [0b01110, 0b10001, 0b10000, 0b01110, 0b00001, 0b10001, 0b01110],
    "T": [0b11111, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100],
    "U": [0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b01110],
    "V": [0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b01010, 0b00100],
    "W": [0b10001, 0b10001, 0b10001, 0b10101, 0b10101, 0b11011, 0b10001],
    "X": [0b10001, 0b10001, 0b01010, 0b00100, 0b01010, 0b10001, 0b10001],
    "Y": [0b10001, 0b10001, 0b01010, 0b00100, 0b00100, 0b00100, 0b00100],
    "Z": [0b11111, 0b00001, 0b00010, 0b00100, 0b01000, 0b10000, 0b11111],
    "[": [0b01110, 0b01000, 0b01000, 0b01000, 0b01000, 0b01000, 0b01110],
    "\\": [0b10000, 0b01000, 0b01000, 0b00100, 0b00010, 0b00010, 0b00001],
    "]": [0b01110, 0b00010, 0b00010, 0b00010, 0b00010, 0b00010, 0b01110],
    "^": [0b00100, 0b01010, 0b10001, 0b00000, 0b00000, 0b00000, 0b00000],
    "_": [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b11111],
    "`": [0b01000, 0b00100, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000],
    "a": [0b00000, 0b00000, 0b01110, 0b00001, 0b01111, 0b10001, 0b01111],
    "b": [0b10000, 0b10000, 0b11110, 0b10001, 0b10001, 0b10001, 0b11110],
    "c": [0b00000, 0b00000, 0b01110, 0b10000, 0b10000, 0b10001, 0b01110],
    "d": [0b00001, 0b00001, 0b01111, 0b10001, 0b10001, 0b10001, 0b01111],
    "e": [0b00000, 0b00000, 0b01110, 0b10001, 0b11111, 0b10000, 0b01110],
    "f": [0b00110, 0b01000, 0b11110, 0b01000, 0b01000, 0b01000, 0b01000],
    "g": [0b00000, 0b00000, 0b01111, 0b10001, 0b01111, 0b00001, 0b01110],
    "h": [0b10000, 0b10000, 0b11110, 0b10001, 0b10001, 0b10001, 0b10001],
    "i": [0b00100, 0b00000, 0b01100, 0b00100, 0b00100, 0b00100, 0b01110],
    "j": [0b00010, 0b00000, 0b00110, 0b00010, 0b00010, 0b10010, 0b01100],
    "k": [0b10000, 0b10000, 0b10010, 0b10100, 0b11000, 0b10100, 0b10010],
    "l": [0b01100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b01110],
    "m": [0b00000, 0b00000, 0b11010, 0b10101, 0b10101, 0b10101, 0b10101],
    "n": [0b00000, 0b00000, 0b11110, 0b10001, 0b10001, 0b10001, 0b10001],
    "o": [0b00000, 0b00000, 0b01110, 0b10001, 0b10001, 0b10001, 0b01110],
    "p": [0b00000, 0b00000, 0b11110, 0b10001, 0b11110, 0b10000, 0b10000],
    "q": [0b00000, 0b00000, 0b01111, 0b10001, 0b01111, 0b00001, 0b00001],
    "r": [0b00000, 0b00000, 0b10110, 0b11000, 0b10000, 0b10000, 0b10000],
    "s": [0b00000, 0b00000, 0b01110, 0b10000, 0b01110, 0b00001, 0b11110],
    "t": [0b01000, 0b01000, 0b11110, 0b01000, 0b01000, 0b01000, 0b00110],
    "u": [0b00000, 0b00000, 0b10001, 0b10001, 0b10001, 0b10011, 0b01101],
    "v": [0b00000, 0b00000, 0b10001, 0b10001, 0b10001, 0b01010, 0b00100],
    "w": [0b00000, 0b00000, 0b10001, 0b10001, 0b10101, 0b10101, 0b01010],
    "x": [0b00000, 0b00000, 0b10001, 0b01010, 0b00100, 0b01010, 0b10001],
    "y": [0b00000, 0b00000, 0b10001, 0b10001, 0b01111, 0b00001, 0b01110],
    "z": [0b00000, 0b00000, 0b11111, 0b00010, 0b00100, 0b01000, 0b11111],
    "{": [0b00010, 0b00100, 0b00100, 0b01000, 0b00100, 0b00100, 0b00010],
    "|": [0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100],
    "}": [0b01000, 0b00100, 0b00100, 0b00010, 0b00100, 0b00100, 0b01000],
    "~": [0b00000, 0b00000, 0b01000, 0b10101, 0b00010, 0b00000, 0b00000],
    "°": [0b00110, 0b01001, 0b01001, 0b00110, 0b00000, 0b00000, 0b00000],
}

# 4x6 smaller font for tighter spaces
FONT_4X6: dict[str, list[int]] = {
    " ": [0b0000, 0b0000, 0b0000, 0b0000, 0b0000, 0b0000],
    "0": [0b0110, 0b1001, 0b1001, 0b1001, 0b1001, 0b0110],
    "1": [0b0010, 0b0110, 0b0010, 0b0010, 0b0010, 0b0111],
    "2": [0b0110, 0b1001, 0b0010, 0b0100, 0b1000, 0b1111],
    "3": [0b0110, 0b1001, 0b0010, 0b0001, 0b1001, 0b0110],
    "4": [0b0010, 0b0110, 0b1010, 0b1111, 0b0010, 0b0010],
    "5": [0b1111, 0b1000, 0b1110, 0b0001, 0b1001, 0b0110],
    "6": [0b0110, 0b1000, 0b1110, 0b1001, 0b1001, 0b0110],
    "7": [0b1111, 0b0001, 0b0010, 0b0100, 0b0100, 0b0100],
    "8": [0b0110, 0b1001, 0b0110, 0b1001, 0b1001, 0b0110],
    "9": [0b0110, 0b1001, 0b0111, 0b0001, 0b0001, 0b0110],
    ".": [0b0000, 0b0000, 0b0000, 0b0000, 0b0000, 0b0100],
    "-": [0b0000, 0b0000, 0b0000, 0b1111, 0b0000, 0b0000],
    "+": [0b0000, 0b0010, 0b0010, 0b1111, 0b0010, 0b0010],
    "$": [0b0010, 0b0111, 0b1000, 0b0110, 0b0001, 0b1110],
    "%": [0b1001, 0b0010, 0b0010, 0b0100, 0b0100, 0b1001],
    "°": [0b0110, 0b1001, 0b0110, 0b0000, 0b0000, 0b0000],
}


class BitmapFont:
    """Bitmap font renderer."""

    def __init__(self, font_data: dict[str, list[int]], width: int, height: int):
        """Initialize font.

        Args:
            font_data: Character bitmap data
            width: Character width in pixels
            height: Character height in pixels
        """
        self.data = font_data
        self.width = width
        self.height = height
        self.spacing = 1  # Pixels between characters

    def get_char_bitmap(self, char: str) -> Optional[list[int]]:
        """Get bitmap data for a character.

        Args:
            char: Single character

        Returns:
            List of row bitmaps, or None if character not found
        """
        return self.data.get(char) or self.data.get(char.upper())

    def measure_text(self, text: str) -> tuple[int, int]:
        """Measure the pixel dimensions of rendered text.

        Args:
            text: Text to measure

        Returns:
            (width, height) tuple
        """
        if not text:
            return (0, 0)
        width = len(text) * self.width + (len(text) - 1) * self.spacing
        return (width, self.height)

    def render_char(
        self,
        char: str,
        color: tuple[int, int, int],
    ) -> list[tuple[int, int, tuple[int, int, int]]]:
        """Render a single character to pixel coordinates.

        Args:
            char: Character to render
            color: RGB color tuple

        Returns:
            List of (x, y, color) tuples for set pixels
        """
        bitmap = self.get_char_bitmap(char)
        if not bitmap:
            return []

        pixels = []
        for y, row in enumerate(bitmap):
            for x in range(self.width):
                # Check if bit is set (MSB first)
                if row & (1 << (self.width - 1 - x)):
                    pixels.append((x, y, color))
        return pixels


# Pre-defined font instances
FONTS = {
    "5x7": BitmapFont(FONT_5X7, 5, 7),
    "4x6": BitmapFont(FONT_4X6, 4, 6),
}


def get_font(name: str) -> BitmapFont:
    """Get a font by name.

    Args:
        name: Font name (e.g., "5x7", "4x6")

    Returns:
        BitmapFont instance

    Raises:
        ValueError: If font not found
    """
    if name not in FONTS:
        raise ValueError(f"Unknown font: {name}. Available: {list(FONTS.keys())}")
    return FONTS[name]
